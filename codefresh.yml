version: '1.0'
steps:

    define_workspace:
      title: Define Workspace
      image: alpine:latest
      commands:
        - cf_export WORKSPACE=$CF_VOLUME_PATH/$CF_REPO_NAME

    define_sdk_home:
      title: Define SDK HOME
      image: alpine:latest
      commands:
        - cf_export SDK_HOME=$WORKSPACE/build/odi-sdk

    gradle_image:
      title: Build Gradle Image
      type: build
      image_name: gradle

    odi_build_images:
      title: Build ODI Images
      type: parallel
      steps:

        image_122130:
          title: Build 12.2.1.3.0 Image
          type: build
          image_name: odi
          tag: 12.2.1.3.0
          working_directory: odi/12.2.1.3.0
          build_arguments:
            - SDK_HOME=${{SDK_HOME}}

        image_122131:
          title: Build 12.2.1.3.1 Image
          type: build
          image_name: odi
          tag: 12.2.1.3.1
          working_directory: odi/12.2.1.3.1
          build_arguments:
            - SDK_HOME=${{SDK_HOME}}

        image_122132:
          title: Build 12.2.1.3.2 Image
          type: build
          image_name: odi
          tag: 12.2.1.3.2
          working_directory: odi/12.2.1.3.2
          build_arguments:
            - SDK_HOME=${{SDK_HOME}}

    odi_copy_jar:
      title: Build ODI SDKs
      type: parallel
      steps:

        sdk_122130:
          title: Build ODI SDK for 12.2.1.3.0
          image: alpine:latest
          working_directory: odi/12.2.1.3.0
          commands:
            - copy_jars.sh

        sdk_122131:
          title: Build ODI SDK for 12.2.1.3.1
          image: alpine:latest
          working_directory: odi/12.2.1.3.1
          commands:
            - copy_jars.sh

        sdk_122132:
          title: Build ODI SDK for 12.2.1.3.2
          image: alpine:latest
          working_directory: odi/12.2.1.3.2
          commands:
            - copy_jars.sh

    inspect_sdk:
      title: Inspect ODI SDK
      image: alpine:latest
      commands:
        - echo "SDK listing:" && ls -lh $WORKSPACE/build/odi-sdk

    release_plugin:
      title: Release Plugin
      image: ${{gradle_image}}
      cmd:
        - cleanLibs
        - release
        - -Prelease.disableChecks
        - -Prelease.localOnly
      when:
        condition:
          all:
            validateTargetBranch: '"${{CF_PULL_REQUEST_TARGET}}" == "master"'
            prActionClose: '"${{CF_PULL_REQUEST_ACTION}}" == "closed"'
            prActionMerge: '"${{CF_PULL_REQUEST_MERGED}}" == "true"'
    
    build_plugin:
      title: Build Plugin
      image: ${{gradle_image}}
      cmd:
        - release
        - -Prelease.disableChecks
        - -Prelease.localOnly
        - -Prelease.dryRun
        - build
        - copyBuildResources

    inspect_plugin:
      title: Inspect Plugin
      image: alpine:latest
      commands:
        - ls -lh build/libs

    publish_plugin:
      title: Publish Plugin
      image: ${{gradle_image}}
      cmd:
        - publishVersionDocs
        - publishLatestDocs
        - githubRelease
        - publishPlugins
        - -Si
      when:
        condition:
          all:
            validateTargetBranch: '"${{CF_PULL_REQUEST_TARGET}}" == "master"'
            prActionClose: '"${{CF_PULL_REQUEST_ACTION}}" == "closed"'
            prActionMerge: '"${{CF_PULL_REQUEST_MERGED}}" == "true"'

    analytics_producer:
      title: Analytics Producer
      image: ${{gradle_image}}
      cmd:
        - producer
